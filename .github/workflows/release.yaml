name: Release

on:
  release:
    types: [created]

permissions:
  contents: write
  packages: write

jobs:
  goreleaser:
    runs-on: depot-ubuntu-24.04-8
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Setup Go
        uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod
          cache: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@e435ccd777264be153ace6237001ef4d979d3a7a # v6.4.0
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute release image tag
        id: release_image_tag
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          IMAGE_TAG="${RELEASE_TAG#v}"
          test -n "$IMAGE_TAG"
          echo "value=$IMAGE_TAG" >> "$GITHUB_OUTPUT"

      - name: Trivy image scan (release)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: image
          image-ref: ghcr.io/coder/coder-k8s:${{ steps.release_image_tag.outputs.value }}
          severity: HIGH,CRITICAL
          exit-code: '1'
